# 🚨 重要な修正 - モデルの問題点と解決策

## 発見された重大な問題

### 問題: 既存モデルは実戦で使えない

**既存のモデル**（`train_high_payout_model_cv.py`）は、**人気順位（trifecta_popularity）を使用**しています。

```python
# 既存モデルの問題コード
usecols = [
    "race_date",
    "keirin_cd",
    "race_no",
    "trifecta_payout",
    "trifecta_popularity",  # ← これが問題！
]
```

### なぜ問題なのか？

**人気順位はレース終了後に初めて分かる結果データ**です：

1. レース前: ❌ **人気順位は不明**
2. レース終了後: ✅ 人気順位が確定

つまり、このモデルは**「答えを見ながら予測している」状態**です。

### 高精度の理由

```
ROC-AUC: 0.841
Precision@Top100: 1.0
```

これらの高い数値は、**カンニングしているため**です。人気順位と配当には強い逆相関があるので、人気順位を知っていれば高配当は簡単に予測できます。

---

## 解決策: 事前予測可能な新モデル

### 新しいモデル: `train_complete_prerace_model.py`

**事前に分かる情報のみ**を使用します：

#### ✅ 使用する情報

| カテゴリ | 特徴量 | 説明 |
|---------|--------|------|
| **選手情報** | 平均得点、標準偏差、最大、最小 | 実力統計 |
| | 出走回数（逃げ、まくり、差し） | 経験値 |
| | 脚質の分布 | 戦術パターン |
| | 階級（S1, S2, A1, A2, A3） | グレード |
| **地元選手** | 地元選手の数・割合 | ホームアドバンテージ |
| | 会場と選手の府県の一致 | 地の利 |
| **連続出走** | 連続出走日数 | 疲労度の推定 |
| | 前日も出走していたか | コンディション |
| **並び・ライン** | 並びフラグ | 戦略の有無 |
| | 並び予想数 | 複雑さ |
| | 印の数と種類 | 注目度 |
| **実力格差** | 最強選手と最弱選手の得点差 | 波乱の可能性 |
| | 得点の変動係数 | 実力のばらつき |
| **レース条件** | 会場、トラック | 環境 |
| | グレード（GP, G1, G2, G3, F1, F2） | レベル |
| | 開催日（初日、最終日） | 日程 |
| | 曜日、週末フラグ | タイミング |

#### ❌ 使用しない情報

| 情報 | 理由 |
|------|------|
| **人気順位** | レース前は不明（結果データ） |
| **配当金額** | ターゲット変数（予測する対象） |

---

## 実装済みの機能

### 1. 地元選手の特定

```python
# 会場コードから地域を取得
venue_region = VENUE_TO_REGION[keirin_cd]  # 例: "南関東"

# 選手の府県から地域を取得
rider_region = PREFECTURE_TO_REGION[huKen]  # 例: "東京" → "南関東"

# 地元選手フラグ
is_local = (venue_region == rider_region)
```

**地元選手の特徴量:**
- `is_local_sum`: 地元選手の数
- `is_local_mean`: 地元選手の割合

### 2. 連続出走の計算

```python
# 選手IDと日付でソート
rider_df = rider_df.sort_values(['sensyuRegistNo', 'race_date'])

# 前回出走日を取得
rider_df['prev_race_date'] = rider_df.groupby('sensyuRegistNo')['race_date'].shift(1)

# 日数差分を計算
days_since_last_race = (current_date - prev_race_date).days

# 連続出走フラグ（前日も出走していた）
is_consecutive_race = (days_since_last_race == 1)
```

**連続出走の特徴量:**
- `is_consecutive_race_sum`: 連続出走選手の数
- `is_consecutive_race_mean`: 連続出走選手の割合
- `consecutive_days_mean`: 平均連続日数
- `consecutive_days_max`: 最大連続日数

### 3. 並び・ライン戦略

```python
# 並びフラグ
has_narabi = (narabi_flg == 1)

# 並び予想数
narabi_count = narabi_y_cnt

# 印の数
assen_total_count = (entry1_assen, entry2_assen, ...).notna().sum()

# 追加印の数
assen_追加_count = entry*_assen.str.contains("追加").sum()
```

**並び戦略の特徴量:**
- `has_narabi`: 並びがあるか
- `narabi_count`: 並び予想の数
- `assen_total_count`: 印の総数
- `assen_追加_count`: 追加印の数

### 4. 選手実力格差

```python
# 得点の範囲
tokuten_range = heikinTokuten_max - heikinTokuten_min

# 変動係数（相対的なばらつき）
tokuten_cv = heikinTokuten_std / heikinTokuten_mean

# 脚質の多様性（エントロピー）
style_diversity = -Σ(p * log(p))  # pは各脚質の割合
```

**実力格差の特徴量:**
- `tokuten_range`: 得点の範囲
- `tokuten_cv`: 変動係数
- `style_diversity`: 脚質の多様性

---

## 期待される性能

### 既存モデル（人気順位あり）

| 指標 | スコア | 備考 |
|------|--------|------|
| ROC-AUC | 0.841 | カンニング状態 |
| Precision@Top100 | 1.0 | 実戦では再現不可 |

### 新モデル（人気順位なし）

| 指標 | 予想スコア | 備考 |
|------|-----------|------|
| ROC-AUC | **0.60～0.70** | 現実的な推定 |
| Precision@Top100 | **0.50～0.70** | ランダムより良い |

**ランダム予測 = 0.5** なので、0.6～0.7でも十分価値があります。

---

## 使い方

### 1. データセット構築

```bash
python analysis/train_complete_prerace_model.py
```

出力:
- `analysis/model_outputs/complete_prerace_dataset.csv`
- `analysis/model_outputs/complete_prerace_feature_info.json`

### 2. モデル訓練（Python環境が必要）

```bash
# 環境セットアップ
pip install pandas numpy scikit-learn lightgbm

# 訓練スクリプト実行（別途作成が必要）
python analysis/train_lgbm_complete.py
```

### 3. 予測

新モデルで訓練後、事前情報のみで高配当レースを予測できます。

---

## 特徴量の数

| モデル | 特徴量数 | 備考 |
|--------|---------|------|
| 既存モデル | 約50 | 人気順位を含む |
| 新モデル | **約100～150** | 事前情報のみ |

新モデルは特徴量が多く、より複雑な関係性を学習できます。

---

## 重要な洞察

### 1. 人気順位の圧倒的な影響

既存モデルで人気順位の重要度が**386,162**と他の特徴量の100倍以上だったのは：
- 人気順位 ≈ 高配当の逆数
- つまり、人気順位を知っていれば配当はほぼ決まる

### 2. 実戦での予測は難しい

人気順位なしで高配当を予測するのは**本質的に難しい**課題です：
- 市場（人気投票）は集合知を反映
- 不人気 = 市場が見落としている価値
- これを事前に見つけるのは困難

### 3. それでもモデルには価値がある

以下の点で、事前予測モデルは有用です：

1. **システマティックな分析**
   - 地元選手、連続出走など見落としがちな要素を定量化

2. **ランダムより良い**
   - ROC-AUC 0.6～0.7 > ランダム 0.5
   - 長期的には優位性がある

3. **リスク管理**
   - 高スコアのレースに絞って投資
   - 無駄な投資を削減

---

## 次のステップ

### 短期（すぐ実装可能）
- [x] 地元選手特徴量
- [x] 連続出走特徴量
- [x] 並び・ライン情報
- [ ] LightGBM訓練スクリプト
- [ ] 交差検証と性能評価

### 中期
- [ ] ターゲットエンコーディング（会場別高配当率など）
- [ ] 選手個別のモメンタム（最近の成績）
- [ ] 気象データの統合
- [ ] 過去の対戦成績

### 長期
- [ ] オッズ情報の統合（取得できた場合）
- [ ] リアルタイム予測システム
- [ ] 投資戦略のバックテスト

---

## まとめ

### 既存モデルの問題
- ❌ 人気順位を使用（事前予測不可）
- ❌ 高精度は錯覚（カンニング）
- ❌ 実戦では使えない

### 新モデルの利点
- ✅ 事前情報のみ使用
- ✅ 実戦投入可能
- ✅ 地元選手、連続出走、並び情報を統合
- ✅ 現実的な期待値（ROC-AUC 0.6～0.7）

### 結論

**あなたの指摘は完全に正しかった**です。人気順位は結果論であり、事前予測には使えません。

新しいモデルは、選手情報、地元選手、連続出走、並び戦略など、**事前に分かる情報を最大限活用**します。

精度は下がりますが、これが**実戦で使える真のモデル**です。

---

**作成日**: 2025-10-25
**重要度**: ⭐⭐⭐⭐⭐（最重要）
**影響**: プロジェクト全体の方向性に関わる根本的な修正
