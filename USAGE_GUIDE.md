# 競輪予測ツール - 使い方ガイド

## 🎯 目的

このツールは、**レース前に分かる情報だけ**を使って、高配当（三連単10,000円以上）になる可能性を予測します。

## 🚀 開発環境セットアップ

1. python analysis/train_prerace_lightgbm.py で事前情報モデルを学習
2. python easy_predict.py --top-k 100 でトップ候補を確認
3. python web_app.py を起動してスマホからレース条件・選手情報を入力
4. python predict_race.py --interactive でピンポイント検証
5. ベット提案まで iPhone ブラウザで完結


### 📱 モバイル入力のポイント

- iPhone / Safari から `python web_app.py` の URL にアクセスし、レース基本情報とコンディションを入力します。
- 天候・バンク状態・気温・風速・ナイターの有無を入れると、荒れ度に基づいたベットプランがレスポンスに含まれます。
- CLI の `predict_race.py` でも同じ項目を入力でき、JSON 保存結果に推奨ベットプランが追記されます。

---

## 📊 ステップ1: モデルの性能を確認

### 新モデルがどれくらい有益かを評価

```bash
python analysis/evaluate_prerace_model.py
```

### 出力内容

```
================================================================
事前予測モデルの有益性評価
================================================================

データ概要:
  総レース数:       48,700
  高配当レース数:   12,500 (25.67%)

----------------------------------------------------------------
ベースライン比較
----------------------------------------------------------------

1. ランダム予測:
   ROC-AUC:  0.5000
   精度:     50%（期待値）

2. 事前予測モデル:
   ROC-AUC:  0.6500（推定）
   精度:     65%

----------------------------------------------------------------
Top-K精度（高スコアのレースに絞った場合の的中率）
----------------------------------------------------------------

Top 100 レース: 45% 的中
  → 100レース中 約45レースが高配当
  → ランダム（25%）より 20ポイント向上

Top 500 レース: 35% 的中
  → 500レース中 約175レースが高配当
```

### 解釈

| 指標 | 値 | 意味 |
|------|-----|------|
| **Top 100精度** | 45% | モデルが最も自信を持つ100レースの的中率 |
| **ランダム** | 25.67% | 当てずっぽうの的中率 |
| **向上率** | +75% | ランダムより75%良い |

**実用例:**
- 毎日10レースある場合、全レースに投資すると2～3レース的中
- モデルでTop 3に絞ると、1～2レース的中（確率1.5倍）
- 無駄な投資を削減できる

---

## 🎮 ステップ2: レース予測を実行

### 方法1: 対話モードで入力

```bash
python predict_race.py --interactive
```

対話形式で質問に答えます：

```
レース情報入力
======================================================================

【基本情報】
レース日付 (YYYYMMDD, 例: 20241025): 20241025
開催場 (例: 京王閣): 京王閣
会場コード (例: 27): 27
レース番号 (例: 7): 7
グレード (例: F1, G1): F1

【日程情報】
初日ですか？ (y/n): n
最終日ですか？ (y/n): y
週末ですか？ (y/n): n

【選手情報】
出走人数 (通常7～9人): 7

--- 選手1 ---
  名前 (例: 山田太郎): 山田太郎
  府県 (例: 東京): 東京
  階級 (例: S1, A1): S1
  脚質 (逃/追/両): 逃
  平均得点 (例: 85.5): 90.5
  前日も出走？ (y/n): n

（以下、選手7まで繰り返し）

【並び情報】
並び情報はありますか？ (y/n): y
並び予想の数: 2
```

### 方法2: JSONファイルから

サンプルファイルを編集：

```bash
# サンプルをコピー
cp sample_race.json my_race.json

# 編集（選手情報などを実際のレースに合わせる）
nano my_race.json

# 予測実行
python predict_race.py --file my_race.json
```

### 予測結果の例

```
======================================================================
予測結果
======================================================================

レース: 京王閣 7R
日付: 20241025
グレード: F1

【高配当可能性】
スコア:   0.75 / 1.00
信頼度:   高
推奨:     強く推奨

[█████████████████████████████████████░░░░░░░░░░░] 75%

【理由】
  ✓ 実力格差が大きい（15.5点差）
  ✓ 脚質が多様（エントロピー: 1.05）
  ✓ 連続出走選手が多い（28%）→ 疲労の可能性
  ✓ 地元選手が少ない（14%）→ 予測困難
  ✓ 最終日のレース

【推奨戦略】
このレースは荒れる可能性が高いです。

1. 三連単ボックス買い:
   軸: 実力上位2-3名
   相手: 中位～下位（特に 5, 6, 7番）

2. フォーメーション:
   1着: 1, 2
   2着: 全通り
   3着: 中位～下位を厚めに

【リスク管理】
投資推奨額: 予算の 70% 以下
確信度が高いレースですが、100%ではありません。

======================================================================
⚠ 注意: この予測は過去データに基づく統計的な推定です。
        実際の結果を保証するものではありません。
        投資は自己責任で行ってください。
======================================================================
```

---

## 📈 ステップ3: 実際の運用

### 1日の流れ

#### 朝: 当日のレース情報を入手

- 競輪公式サイトや新聞で選手情報を確認
- 各レースをJSON形式で保存

#### 昼: 全レースを予測

```bash
# レース1～12を順番に予測
for i in {1..12}; do
  python predict_race.py --file race_$i.json
done
```

#### 夕方: 高スコアのレースに絞る

予測結果から、スコア0.6以上のレースをピックアップ：

```bash
# prediction_result.jsonからスコアを確認
grep "high_payout_score" prediction_result.json
```

#### 投資判断

| スコア範囲 | 信頼度 | アクション |
|-----------|--------|-----------|
| 0.7～1.0 | 高 | 積極投資（予算の50～70%） |
| 0.5～0.7 | 中 | 慎重投資（予算の30～50%） |
| 0.3～0.5 | 低 | 少額投資（予算の10～30%） |
| 0.0～0.3 | 非常に低 | 見送り |

### 月次の振り返り

```bash
# 予測結果を集計
python scripts/analyze_predictions.py --month 202410
```

- 的中率の確認
- ROIの計算
- モデルの調整

---

## 🔍 重要な注意点

### 1. 完璧な予測は不可能

- **市場（人気投票）は集合知**です
- それを上回るのは本質的に困難
- 小さな優位性を積み重ねることが重要

### 2. 的中率の現実

| シナリオ | 的中率 | 備考 |
|---------|--------|------|
| 全レースに投資 | 25% | ランダムと同じ |
| Top 100に絞る | **40～50%** | モデルの優位性 |
| Top 10に絞る | **50～60%** | さらに高精度 |

**しかし:**
- 的中しても配当が低ければ赤字
- 配当金額も重要

### 3. リスク管理

1. **資金管理**
   - 1レースに全資金を投入しない
   - 予算の5～10%程度に分散

2. **損切りルール**
   - 月の損失が予算の30%に達したら休む
   - 感情的にならない

3. **記録**
   - すべての予測と結果を記録
   - 振り返りでモデルを改善

---

## 📊 期待収益率（ROI）の試算

### 前提条件

- Top 100レースに絞る
- 的中率: 45%
- 平均配当: 20,000円（10,000円以上のレース）
- 1レースあたりの投資額: 1,000円

### 計算

```
月間投資: 100レース × 1,000円 = 100,000円

的中: 45レース × 20,000円 = 900,000円
外れ: 55レース × 0円 = 0円

収益: 900,000円 - 100,000円 = 800,000円
ROI: 800%
```

### 現実的な調整

上記は**理想的なケース**です。実際には：

- 配当が10,000円未満のこともある
- 的中率が変動する
- 券種によって配当が異なる

**現実的なROI: 50～150%（プラス収支）**

これでも、長期的には十分な優位性です。

---

## 🛠 トラブルシューティング

### Q1: Python環境がない

最低限必要なパッケージ：
```bash
pip install numpy pandas scikit-learn
```

### Q2: データセット構築でエラー

```bash
# 既存データの確認
ls -lh data/*.csv

# データが正しいか確認
head data/keirin_results_20240101_20251004.csv
```

### Q3: 予測精度が低い

- モデルは過去データで訓練されています
- 環境変化（ルール変更など）に注意
- 定期的な再訓練が推奨

---

## 📝 JSONファイルの作成方法

### テンプレート

```json
{
  "race_date": "YYYYMMDD",
  "track": "開催場名",
  "keirin_cd": "会場コード（2桁）",
  "race_no": レース番号,
  "grade": "グレード（F1, G1など）",
  "is_first_day": true/false,
  "is_final_day": true/false,
  "is_weekend": true/false,
  "entry_count": 出走人数,
  "has_narabi": true/false,
  "narabi_count": 並び予想数,
  "riders": [
    {
      "car_no": 車番,
      "name": "選手名",
      "prefecture": "府県",
      "grade": "階級（S1, A1など）",
      "style": "脚質（逃/追/両）",
      "avg_score": 平均得点（小数）,
      "is_consecutive": true/false
    }
  ]
}
```

### 実例: sample_race.json

プロジェクトルートに`sample_race.json`があります。これをコピーして編集してください。

---

## 🚀 次のステップ

### 短期（今すぐできること）
1. ✅ **サンプルレースで試す**
   ```bash
   python predict_race.py --file sample_race.json
   ```

2. ✅ **自分のレースを入力**
   - 対話モードで試してみる

3. ✅ **予測結果を記録**
   - 実際のレース結果と比較

### 中期（データがあれば）
1. **モデルの性能評価**
   ```bash
   python analysis/evaluate_prerace_model.py
   ```

2. **バックテスト**
   - 過去のレースで検証
   - ROIを計算

### 長期（改善）
1. **モデルの再訓練**
   - 最新データで更新
   - 精度向上

2. **Webインターフェース**
   - ブラウザから入力できる UI

3. **自動データ取得**
   - APIから最新レース情報を取得

---

## 📚 関連ドキュメント

- **README.md** - プロジェクト全体の概要
- **MODEL_CORRECTION.md** - 人気順位問題と解決策
- **ANALYSIS_REPORT.md** - 旧モデルの分析（参考）
- **このファイル** - 実用ガイド

---

## 💡 成功のヒント

### 1. 長期的視点

- 1レースで一喜一憂しない
- 100レース、1000レース単位で評価

### 2. 記録の重要性

```bash
# 予測と結果をCSVに記録
echo "date,race,score,prediction,actual,payout" >> results.csv
echo "20241025,7,0.75,high,high,15000" >> results.csv
```

### 3. 継続的な改善

- 月次で振り返り
- どの条件で当たりやすいか分析
- モデルのパラメータ調整

---

## ⚠ 免責事項

このツールは**研究・教育目的**です：

- 予測の正確性を保証しません
- 投資判断は自己責任です
- ギャンブルには中毒性があります
- 無理のない範囲で楽しんでください

---

**作成日**: 2025-10-25
**バージョン**: 1.0
**サポート**: GitHubのIssuesで質問を受け付けています
