<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Á´∂Ëº™ È´òÈÖçÂΩì‰∫àÊ∏¨AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --accent: #f43f5e;
      --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
      --card-bg: rgba(255, 255, 255, 0.05);
      --card-border: rgba(255, 255, 255, 0.1);
      --text: #f8fafc;
      --text-muted: #94a3b8;
      --input-bg: rgba(0, 0, 0, 0.2);
      --glass: backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      background: var(--bg-gradient);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 80px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px 16px;
    }

    header {
      margin-bottom: 24px;
      text-align: center;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(to right, #818cf8, #c084fc);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.02em;
    }

    p.subtitle {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      font-weight: 600;
      font-size: 1rem;
      color: #e2e8f0;
    }

    .section-icon {
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: white;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .form-group {
      margin-bottom: 0;
    }

    .form-group.full {
      grid-column: 1 / -1;
    }

    label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-weight: 500;
    }

    input,
    select {
      width: 100%;
      background: var(--input-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 12px;
      color: white;
      font-size: 0.95rem;
      font-family: inherit;
      transition: all 0.2s;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
    }

    /* Rider Card */
    .rider-card {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
    }

    .rider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .rider-num {
      font-weight: 700;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .rider-remove {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 0.8rem;
      padding: 4px 8px;
      cursor: pointer;
    }

    .rider-row {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .rider-stats-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }

    .rider-extra-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }

    /* Autocomplete */
    .input-wrapper {
      position: relative;
    }

    .autocomplete-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #1e293b;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      margin-top: 4px;
    }

    .autocomplete-item {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.9rem;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:active {
      background: var(--primary);
    }

    .autocomplete-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-left: 8px;
    }

    /* Buttons */
    .btn-primary {
      width: 100%;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      padding: 16px;
      border-radius: 16px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
      transition: transform 0.1s;
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-secondary {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      border: 1px dashed var(--text-muted);
      padding: 12px;
      border-radius: 12px;
      font-size: 0.9rem;
      margin-top: 8px;
      cursor: pointer;
    }

    .floating-action {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      z-index: 50;
    }

    .warning-banner {
      background: rgba(244, 63, 94, 0.15);
      border: 1px solid rgba(244, 63, 94, 0.3);
      color: #fda4af;
      padding: 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      margin-bottom: 20px;
      text-align: center;
    }

    /* Utilities */
    .text-center {
      text-align: center;
    }

    .mb-4 {
      margin-bottom: 16px;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>üéØ Á´∂Ëº™ È´òÈÖçÂΩì‰∫àÊ∏¨AI</h1>
      <p class="subtitle">Ëçí„ÇåÂ∫¶„Çπ„Ç≥„Ç¢ √ó ÊùæÁ´πÊ¢ÖË≤∑„ÅÑÁõÆÊèêÊ°à</p>
    </header>

    <form action="/predict" method="post" class="card">
      <div class="section-header">
        <div class="section-icon">üèÅ</div>
        <div>„É¨„Éº„ÇπÊÉÖÂ†±</div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>Êó•‰ªò</label>
          <input type="date" name="race_date" id="race_date" required>
        </div>
        <div class="form-group">
          <label>Á´∂Ëº™Â†¥</label>
          <input list="track-list" name="track" id="track" placeholder="Á´∂Ëº™Â†¥„ÇíÈÅ∏Êäû" required>
          <datalist id="track-list"></datalist>
          <input type="hidden" name="keirin_cd" id="keirin_cd">
        </div>
        <div class="form-group">
          <label>„É¨„Éº„ÇπÁï™Âè∑</label>
          <input type="number" name="race_no" value="1" min="1" max="12" required>
        </div>
        <div class="form-group">
          <label>„Ç∞„É¨„Éº„Éâ</label>
          <select name="grade">
            <option value="F1">F1</option>
            <option value="F2">F2</option>
            <option value="G3">G3</option>
            <option value="G2">G2</option>
            <option value="G1">G1</option>
            <option value="GP">GP</option>
          </select>
        </div>
      </div>

      <div class="section-header" style="margin-top: 24px;">
        <div class="section-icon">üö¥</div>
        <div>ÈÅ∏ÊâãÊÉÖÂ†± <span id="data-status"
            style="font-size: 0.8rem; color: var(--text-muted); font-weight: normal; margin-left: 10px;">(„Éá„Éº„ÇøË™≠Ëæº‰∏≠...)</span>
        </div>
      </div>

      <div id="rider-list"></div>

      <button type="button" id="add-rider" class="btn-secondary" style="margin-bottom: 60px;">+ ÈÅ∏Êâã„ÇíËøΩÂä†</button>

      <div class="floating-action">
        <button type="submit" class="btn-primary">üéØ È´òÈÖçÂΩì‰∫àÊ∏¨„ÇíÂÆüË°å</button>
      </div>
    </form>
  </div>

  <template id="rider-template">
    <div class="rider-card">
      <div class="rider-header">
        <div class="rider-num">Rider <span class="rider-index"></span></div>
        <button type="button" class="rider-remove">Remove</button>
      </div>

      <div class="rider-row">
        <div class="form-group input-wrapper">
          <label>Name</label>
          <input type="text" name="rider_names" class="rider-name-input" placeholder="Name (e.g. ‰ΩêËó§ÊÖéÂ§™ÈÉé)"
            autocomplete="off" required>
          <div class="autocomplete-suggestions"></div>
        </div>
        <div class="form-group">
          <label>Score</label>
          <input type="number" step="0.01" name="rider_scores" class="rider-score" placeholder="Score" required>
        </div>
      </div>

      <div class="rider-stats-row">
        <div class="form-group">
          <label>Back</label>
          <input type="number" name="rider_back_counts" class="rider-back-count" placeholder="B">
        </div>
        <div class="form-group">
          <label>Pref</label>
          <input type="text" name="rider_prefectures" class="rider-prefecture" placeholder="Pref">
        </div>
        <div class="form-group">
          <label>Grade</label>
          <input type="text" name="rider_grades" class="rider-grade" placeholder="S1">
        </div>
      </div>

      <!-- New Fields for Detailed Features -->
      <div class="rider-extra-row">
        <div class="form-group">
          <label>Recent (1,2,3)</label>
          <input type="text" name="rider_recent_results" class="rider-recent" placeholder="e.g. 1,2,5,1">
        </div>
        <div class="form-group">
          <label>Gear</label>
          <input type="number" step="0.01" name="rider_gears" class="rider-gear" placeholder="3.92">
        </div>
        <div class="form-group">
          <label>H/S</label>
          <input type="text" name="rider_hs_counts" class="rider-hs" placeholder="H:1 S:2">
        </div>
      </div>
      <div class="rider-extra-row">
        <div class="form-group">
          <label>Home Bank?</label>
          <input type="text" name="rider_home_banks" class="rider-home" placeholder="Yes/No or Bank Name">
        </div>
        <div class="form-group">
          <label>Style</label>
          <select name="rider_styles" class="rider-style">
            <option value="ÈÄÉ">ÈÄÉ (Nige)</option>
            <option value="ËøΩ">ËøΩ (Tsui)</option>
            <option value="‰∏°">‰∏° (Ryo)</option>
          </select>
        </div>
        <div class="form-group">
          <label>DQ Pts</label>
          <input type="number" name="rider_dq_points" class="rider-dq" placeholder="0">
        </div>
      </div>

      <!-- Hidden fields for counts -->
      <input type="hidden" name="rider_nige_counts" class="rider-nige-count" value="0">
      <input type="hidden" name="rider_makuri_counts" class="rider-makuri-count" value="0">
      <input type="hidden" name="rider_sasi_counts" class="rider-sasi-count" value="0">
      <input type="hidden" name="rider_mark_counts" class="rider-mark-count" value="0">
    </div>
  </template>

  <script>
    let ridersData = [];
    let tracksData = [];

    async function loadMasterData() {
      const statusEl = document.getElementById('data-status');
      try {
        const [ridersRes, tracksRes] = await Promise.all([
          fetch('/api/riders'),
          fetch('/api/tracks')
        ]);

        if (!ridersRes.ok || !tracksRes.ok) throw new Error("Network response was not ok");

        ridersData = await ridersRes.json();
        tracksData = await tracksRes.json();

        const trackList = document.getElementById('track-list');
        tracksData.forEach(track => {
          const option = document.createElement('option');
          option.value = track.name;
          trackList.appendChild(option);
        });

        statusEl.textContent = `(Ë™≠ËæºÂÆå‰∫Ü: ${ridersData.length}Âêç)`;
        statusEl.style.color = '#4ade80'; // Green
      } catch (e) {
        console.error("Data load error", e);
        statusEl.textContent = "(„Éá„Éº„ÇøË™≠Ëæº„Ç®„É©„Éº)";
        statusEl.style.color = '#f43f5e'; // Red
      }
    }

    document.getElementById('track').addEventListener('input', function () {
      const track = tracksData.find(t => t.name === this.value);
      if (track) document.getElementById('keirin_cd').value = track.code;
    });

    const riderList = document.getElementById("rider-list");
    const template = document.getElementById("rider-template");
    const MAX_RIDERS = 9;

    function addRider() {
      if (riderList.children.length >= MAX_RIDERS) return;

      const clone = template.content.cloneNode(true);
      const card = clone.querySelector(".rider-card");

      card.querySelector(".rider-remove").addEventListener("click", () => {
        card.remove();
        updateIndices();
      });

      setupAutocomplete(card);
      riderList.appendChild(card);
      updateIndices();
    }

    function updateIndices() {
      riderList.querySelectorAll(".rider-index").forEach((el, i) => el.textContent = i + 1);
    }

    function setupAutocomplete(card) {
      const input = card.querySelector('.rider-name-input');
      const suggestions = card.querySelector('.autocomplete-suggestions');

      input.addEventListener('input', function () {
        const val = this.value.toLowerCase();

        if (!val) {
          suggestions.style.display = 'none';
          return;
        }

        const matches = ridersData.filter(r => r.name.includes(val)).slice(0, 50);

        if (matches.length) {
          suggestions.innerHTML = matches.map(r => `
            <div class="autocomplete-item" data-name="${r.name}">
              <div style="font-weight:600">${r.name}</div>
              <div class="autocomplete-meta">${r.prefecture} / ${r.grade} / Avg: ${r.avg_score}</div>
            </div>
          `).join('');
          suggestions.style.display = 'block';

          suggestions.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', () => {
              const r = ridersData.find(d => d.name === item.dataset.name);
              if (r) fillRiderData(card, r);
              suggestions.style.display = 'none';
            });
          });
        } else {
          suggestions.style.display = 'none';
        }
      });

      document.addEventListener('click', e => {
        if (!card.contains(e.target)) suggestions.style.display = 'none';
      });
    }

    function fillRiderData(card, r) {
      card.querySelector('.rider-name-input').value = r.name;
      card.querySelector('.rider-score').value = r.avg_score || '';
      card.querySelector('.rider-back-count').value = r.back_count || 0;
      card.querySelector('.rider-prefecture').value = r.prefecture || '';
      card.querySelector('.rider-grade').value = r.grade || '';

      if (card.querySelector('.rider-nige-count')) {
        card.querySelector('.rider-nige-count').value = r.nige_count || 0;
      }
      if (card.querySelector('.rider-makuri-count')) {
        card.querySelector('.rider-makuri-count').value = r.makuri_count || 0;
      }
      if (card.querySelector('.rider-sasi-count')) {
        card.querySelector('.rider-sasi-count').value = r.sasi_count || 0;
      }
      if (card.querySelector('.rider-mark-count')) {
        card.querySelector('.rider-mark-count').value = r.mark_count || 0;
      }

      const styleSelect = card.querySelector('.rider-style');
      if (r.style && ['ÈÄÉ', 'ËøΩ', '‰∏°'].includes(r.style)) {
        styleSelect.value = r.style;
      }
    }

    document.getElementById('add-rider').addEventListener('click', addRider);
    document.getElementById('race_date').valueAsDate = new Date();

    // Init with 7 riders
    for (let i = 0; i < 7; i++) addRider();
    loadMasterData();
  </script>
</body>

</html>