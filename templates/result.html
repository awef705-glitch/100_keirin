<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ç«¶è¼ª é«˜é…å½“äºˆæ¸¬ : çµæœ</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f0f3ff;
      --card: #ffffff;
      --primary: #2b59c3;
      --accent: #f97316;
      --text: #1f2933;
      --muted: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #dde7ff, #f6f7fb 45%);
      color: var(--text);
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 32px 18px 80px;
    }

    .notice {
      background: rgba(249, 115, 22, 0.12);
      color: var(--accent);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 18px;
      text-align: center;
      font-weight: 600;
    }

    .score-card {
      background: linear-gradient(135deg, #2b59c3, #4f8ae2);
      border-radius: 18px;
      padding: 24px;
      color: #fff;
      text-align: center;
      box-shadow: 0 18px 48px rgba(43, 89, 195, 0.28);
    }

    .score-card h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.08em;
      opacity: 0.85;
    }

    .probability {
      font-size: 3.2rem;
      margin: 12px 0 6px;
      font-weight: 700;
    }

    .confidence {
      font-size: 1rem;
      opacity: 0.85;
    }

    .recommendation {
      margin-top: 12px;
      display: inline-block;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.18);
      font-size: 0.9rem;
    }

    .risk-chip {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(249, 115, 22, 0.18);
      color: #fff;
      font-size: 0.85rem;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .section {
      margin-top: 26px;
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 12px 32px rgba(43, 89, 195, 0.08);
    }

    .section h3 {
      margin: 0 0 12px;
      font-size: 1.02rem;
    }

    .reasons {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .reasons li {
      padding: 12px;
      border-radius: 12px;
      background: rgba(43, 89, 195, 0.08);
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .ticket-list {
      display: grid;
      gap: 12px;
      margin: 16px 0 12px;
    }

    .ticket-item {
      background: rgba(43, 89, 195, 0.08);
      border-radius: 12px;
      padding: 14px;
    }

    .ticket-item strong {
      display: block;
      margin-bottom: 6px;
    }

    .summary-grid,
    .condition-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }

    .summary-item,
    .condition-item {
      border: 1px solid #e5e9f5;
      border-radius: 12px;
      padding: 12px;
      background: rgba(43, 89, 195, 0.04);
    }

    .summary-item span,
    .condition-item span {
      display: block;
      font-size: 0.7rem;
      color: var(--muted);
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.92rem;
    }

    th,
    td {
      border-bottom: 1px solid #e5e9f5;
      padding: 10px;
      text-align: left;
    }

    th {
      background: rgba(43, 89, 195, 0.08);
      font-weight: 600;
    }

    .btn-back {
      margin-top: 28px;
      display: inline-block;
      padding: 12px 20px;
      border-radius: 12px;
      border: 1px solid #94a3b8;
      text-decoration: none;
      color: var(--primary);
      font-weight: 600;
    }

    .warning {
      margin-top: 18px;
      font-size: 0.85rem;
      color: var(--muted);
      line-height: 1.6;
    }
  </style>
</head>

<body>
  <div class="page">
    {% if not lightgbm_ready %}
    <div class="notice">
      ã“ã®çµæœã¯ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯æ¨å®šã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã€‚LightGBM ãƒ¢ãƒ‡ãƒ«ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã«ã¯ <code>KEIRIN_ENABLE_LIGHTGBM=1</code> ã‚’è¨­å®šã—ã€æœ€æ–°ãƒ¢ãƒ‡ãƒ«ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚
    </div>
    {% endif %}

    <div class="score-card">
      <div class="risk-chip">{{ result.betting_plan.risk_level }}</div>
      <h2>è’ã‚Œåº¦ã‚¹ã‚³ã‚¢</h2>
      <div class="probability">{{ '%.1f'|format(probability) }}</div>
      <div class="confidence">ä¿¡é ¼åº¦: {{ result.confidence }}</div>
      <div class="recommendation">{{ result.recommendation }}</div>
    </div>

    <div class="section">
      <h3>è’ã‚Œãã†ãªç†ç”±ãƒˆãƒƒãƒ— {{ result.reasons|length }}</h3>
      <ul class="reasons">
        {% for reason in result.reasons %}
        <li>{{ reason }}</li>
        {% endfor %}
      </ul>
    </div>

    <div class="section">
      <h3>æ¨å¥¨ãƒ™ãƒƒãƒ†ã‚£ãƒ³ã‚°ãƒ—ãƒ©ãƒ³</h3>
      <p>{{ result.betting_plan.plan_summary }}</p>
      <div class="ticket-list">
        {% for ticket in result.betting_plan.ticket_plan %}
        <div class="ticket-item">
          <strong>{{ ticket.label }}</strong>
          <span>{{ ticket.description }}</span>
        </div>
        {% endfor %}
      </div>
      <p class="warning"><strong>è³‡é‡‘é…åˆ†:</strong> {{ result.betting_plan.money_management }}</p>
      <p class="warning"><strong>ãƒ˜ãƒƒã‚¸æ¡ˆ:</strong> {{ result.betting_plan.hedge_note }}</p>
    </div>

    <div class="section">
      <h3>å…¥åŠ›æ¡ä»¶ã‚µãƒãƒª</h3>
      <div class="condition-grid">
        <div class="condition-item">
          <span>é–‹å‚¬æ—¥</span>
          {{ summary.race_date }}
        </div>
        <div class="condition-item">
          <span>é–‹å‚¬å ´</span>
          {{ summary.track or race.track or 'æœªå…¥åŠ›' }}
        </div>
        <div class="condition-item">
          <span>ã‚°ãƒ¬ãƒ¼ãƒ‰</span>
          {{ summary.grade or race.grade or '-' }}
        </div>
        <div class="condition-item">
          <span>å¤©å€™</span>
          {{ summary.weather_condition or race.weather_condition or '-' }}
        </div>
        <div class="condition-item">
          <span>ãƒãƒ³ã‚¯çŠ¶æ…‹</span>
          {{ summary.track_condition or race.track_condition or '-' }}
        </div>
        <div class="condition-item">
          <span>æ°—æ¸©</span>
          {% if summary.temperature_c is not none %}
          {{ '%.1fâ„ƒ'|format(summary.temperature_c) }}
          {% elif race.temperature %}
          {{ race.temperature }}â„ƒ
          {% else %}
          -
          {% endif %}
        </div>
        <div class="condition-item">
          <span>é¢¨é€Ÿ / é¢¨å‘</span>
          {% if summary.wind_speed_mps is not none %}
          {{ '%.1f m/s'|format(summary.wind_speed_mps) }} {{ summary.wind_direction or '' }}
          {% elif race.wind_speed %}
          {{ race.wind_speed }} m/s {{ race.wind_direction or '' }}
          {% else %}
          -
          {% endif %}
        </div>
        <div class="condition-item">
          <span>é–‹å‚¬æ—¥ç¨‹</span>
          {% if summary.meeting_day %}
          {{ summary.meeting_day }}æ—¥ç›®
          {% else %}
          {{ race.meeting_day or '-' }}
          {% endif %}
        </div>
        <div class="condition-item">
          <span>ãƒŠã‚¤ã‚¿ãƒ¼</span>
          {% if summary.is_night_race or race.is_night_race %}
          ãƒŠã‚¤ã‚¿ãƒ¼
          {% else %}
          æ˜¼é–‹å‚¬
          {% endif %}
        </div>
      </div>
      {% if race.notes %}
      <p class="warning" style="margin-top:14px;"><strong>ãƒ¡ãƒ¢:</strong> {{ race.notes }}</p>
      {% endif %}
    </div>

    <div class="section">
      <h3>ç‰¹å¾´é‡ã‚µãƒãƒª</h3>
      <div class="summary-grid">
        <div class="summary-item">
          <span>ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ•°</span>
          {{ summary.entry_count }}
        </div>
        <div class="summary-item">
          <span>å¹³å‡å¾—ç‚¹</span>
          {{ '%.2f'|format(summary.score_mean or 0.0) }}
        </div>
        <div class="summary-item">
          <span>å¾—ç‚¹ãƒ¬ãƒ³ã‚¸</span>
          {{ '%.2f'|format(summary.score_range or 0.0) }}
        </div>
        <div class="summary-item">
          <span>å¾—ç‚¹CV</span>
          {{ '%.2f'|format(summary.score_cv or 0.0) }}
        </div>
        <div class="summary-item">
          <span>è„šè³ªå¤šæ§˜æ€§</span>
          {{ '%.2f'|format(summary.style_diversity or 0.0) }}
        </div>
        <div class="summary-item">
          <span>åœ°åŒºã®ã°ã‚‰ã¤ã</span>
          {{ summary.prefecture_unique_count or 0 }}
        </div>
      </div>
    </div>

    <div class="section">
      <h3>å…¥åŠ›ã—ãŸé¸æ‰‹ä¸€è¦§</h3>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>åå‰</th>
            <th>åºœçœŒ</th>
            <th>éšç´š</th>
            <th>è„šè³ª</th>
            <th>å¾—ç‚¹</th>
          </tr>
        </thead>
        <tbody>
          {% for rider in riders %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ rider.name }}</td>
            <td>{{ rider.prefecture }}</td>
            <td>{{ rider.grade }}</td>
            <td>{{ rider.style }}</td>
            <td>
              {% if rider.avg_score is not none %}
              {{ '%.2f'|format(rider.avg_score) }}
              {% else %}
              -
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if betting_suggestions and not betting_suggestions.get('error') %}
    <div class="section"
      style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
      <h3 style="color: white;">ğŸ’° å…·ä½“çš„ãªè²·ã„ç›®ææ¡ˆ (è’ã‚Œåº¦: {{ '%.1f'|format(betting_suggestions.roughness_score) }})</h3>

      <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
        <h4 style="color: white; font-size: 0.95rem; margin-bottom: 10px;">é¸æ‰‹è©•ä¾¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
        {% for rider in betting_suggestions.rider_ranking[:6] %}
        <div style="padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
          {{ loop.index }}ä½: {{ rider.car_no }}ç•ª {{ rider.name }}
          ({{ rider.grade }}/{{ rider.style }}{% if rider.avg_score %}/å¾—ç‚¹:{{ '%.1f'|format(rider.avg_score) }}{% endif
          %})
          <span style="opacity: 0.8; margin-left: 10px;">è©•ä¾¡:{{ '%.1f'|format(rider.strength) }}</span>
        </div>
        {% endfor %}
      </div>

      {% set tiers = [
      ('æ¢… (å°‘é¡ãƒ»æ‰‹å …ã)', 'low_cost', '#10b981'),
      ('ç«¹ (ä¸­é¡ãƒ»ãƒãƒ©ãƒ³ã‚¹)', 'mid_cost', '#f59e0b'),
      ('æ¾ (é«˜é…å½“ç‹™ã„)', 'high_cost', '#ef4444'),
      ('æ¾ãƒ»çµã‚Š (é«˜é…å½“ãƒ»å³é¸)', 'high_cost_reduced', '#8b5cf6')
      ] %}

      {% for label, key, color in tiers %}
      {% set sugs = betting_suggestions.suggestions[key] %}
      {% set strategy = betting_suggestions.strategies[key] %}
      {% set points = sugs|length %}
      {% set cost = points * 100 %}

      {% if points > 0 %}
      <div
        style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 5px solid {{ color }};">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <h4 style="color: white; font-size: 1rem; margin: 0;">{{ label }}</h4>
          <span style="font-size: 0.9rem; opacity: 0.9;">{{ points }}ç‚¹ (Â¥{{ cost }})</span>
        </div>
        <p style="font-size: 0.9rem; margin-bottom: 10px; opacity: 0.9;">æˆ¦ç•¥: {{ strategy }}</p>

        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
          {% for sug in sugs %}
          <div
            style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 8px; font-size: 0.85rem; text-align: center;">
            <strong style="display: block; font-size: 1rem; margin-bottom: 2px;">{{ sug.combination }}</strong>
            <span style="opacity: 0.8; font-size: 0.75rem;">{{ sug.type }}</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      {% endfor %}

    </div>
    {% endif %}

    <a href="/" class="btn-back">â†© æ–°ã—ã„ãƒ¬ãƒ¼ã‚¹ã‚’å…¥åŠ›ã™ã‚‹</a>

    <div class="warning">
      å…è²¬: æœ¬ãƒ„ãƒ¼ãƒ«ã¯éå»ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãçµ±è¨ˆçš„æ¨å®šã§ã™ã€‚å®Ÿéš›ã®çµæœã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æŠ•ç¥¨ã¯è‡ªå·±è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„ã€‚
    </div>
  </div>
</body>

</html>